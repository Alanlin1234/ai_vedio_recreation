# AI è§†é¢‘åˆ›ä½œ Agent ç³»ç»Ÿ - å®Œæ•´è¯´æ˜æ–‡æ¡£

## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
3. [æ ¸å¿ƒæ–‡ä»¶è¯´æ˜](#æ ¸å¿ƒæ–‡ä»¶è¯´æ˜)
4. [Agent è¯¦ç»†è¯´æ˜](#agent-è¯¦ç»†è¯´æ˜)
5. [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
6. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
7. [API æ¥å£](#api-æ¥å£)
8. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)

---

## ç³»ç»Ÿæ¦‚è¿°

### ç³»ç»ŸåŠŸèƒ½

è¿™æ˜¯ä¸€ä¸ª**ç«¯åˆ°ç«¯çš„ AI è§†é¢‘è‡ªåŠ¨åˆ›ä½œç³»ç»Ÿ**ï¼Œèƒ½å¤Ÿä»æŠ–éŸ³çƒ­ç‚¹é‡‡é›†åˆ°æœ€ç»ˆè§†é¢‘ç”Ÿæˆçš„å…¨æµç¨‹è‡ªåŠ¨åŒ–ã€‚

### æ ¸å¿ƒèƒ½åŠ›

âœ… **çƒ­ç‚¹é‡‡é›†** - è‡ªåŠ¨è·å–æŠ–éŸ³å½“æ—¥çƒ­ç‚¹æ—¶è¯„  
âœ… **è„šæœ¬ç”Ÿæˆ** - AI è‡ªåŠ¨æ‹†è§£è§†é¢‘è„šæœ¬å’Œåœºæ™¯  
âœ… **åˆ†é•œè§„åˆ’** - æ™ºèƒ½è§„åˆ’é•œå¤´å’Œè§†è§‰æ•ˆæœ  
âœ… **å‚è€ƒå›¾é€‰å–** - ä¸ºæ¯ä¸ªé•œå¤´åŒ¹é…å‚è€ƒå›¾  
âœ… **å›¾åƒç”Ÿæˆ** - é›†æˆ ComfyUI ç”Ÿæˆé«˜è´¨é‡å›¾åƒ  
âœ… **ä¸€è‡´æ€§æ£€éªŒ** - è‡ªåŠ¨æ£€æŸ¥å›¾åƒé£æ ¼å’Œè´¨é‡ä¸€è‡´æ€§  
âœ… **è§†é¢‘åˆæˆ** - å°†æ‰€æœ‰ç´ æåˆæˆæœ€ç»ˆè§†é¢‘

### æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: FastAPI (Python 3.8+)
- **å¼‚æ­¥å¤„ç†**: asyncio, aiohttp
- **å›¾åƒç”Ÿæˆ**: ComfyUI API
- **è§†é¢‘å¤„ç†**: MoviePy
- **æ—¥å¿—ç³»ç»Ÿ**: Python logging

---

## æ•´ä½“æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·è¾“å…¥ / API è¯·æ±‚                        â”‚
â”‚              (å…³é”®è¯ã€é£æ ¼ã€æ—¶é•¿ç­‰å‚æ•°)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              VideoCreationOrchestrator                       â”‚
â”‚                   (æµç¨‹ç¼–æ’å™¨)                                â”‚
â”‚         ç»Ÿä¸€åè°ƒå’Œç®¡ç†æ‰€æœ‰ Agent çš„æ‰§è¡Œ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HotspotAgent â”‚  â”‚ ScriptAgent  â”‚  â”‚StoryboardAgentâ”‚
â”‚  çƒ­ç‚¹é‡‡é›†     â”‚â†’ â”‚  è„šæœ¬æ‹†è§£     â”‚â†’ â”‚  åˆ†é•œè§„åˆ’     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ReferenceAgentâ”‚â†’ â”‚ImageGeneration   â”‚â†’ â”‚Consistency   â”‚
â”‚  å‚è€ƒå›¾é€‰å–   â”‚  â”‚Agent (ComfyUI)   â”‚  â”‚Agent         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚VideoSynthesisâ”‚
                                    â”‚Agent         â”‚
                                    â”‚  è§†é¢‘åˆæˆ     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  æœ€ç»ˆè§†é¢‘     â”‚
                                    â”‚  MP4 æ–‡ä»¶     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµè½¬

```
çƒ­ç‚¹æ•°æ® â†’ è„šæœ¬åœºæ™¯ â†’ é•œå¤´åˆ—è¡¨ â†’ å¸¦å‚è€ƒå›¾çš„é•œå¤´ â†’ ç”Ÿæˆçš„å›¾åƒ â†’ æ£€éªŒåçš„å›¾åƒ â†’ æœ€ç»ˆè§†é¢‘
```

---

## æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

### ğŸ“ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ agents/                    # Agent æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ base_agent.py         # Agent åŸºç±»
â”‚   â”‚   â”œâ”€â”€ orchestrator.py       # æµç¨‹ç¼–æ’å™¨
â”‚   â”‚   â”œâ”€â”€ hotspot_agent.py      # çƒ­ç‚¹é‡‡é›† Agent
â”‚   â”‚   â”œâ”€â”€ script_agent.py       # è„šæœ¬æ‹†è§£ Agent
â”‚   â”‚   â”œâ”€â”€ storyboard_agent.py   # åˆ†é•œè§„åˆ’ Agent
â”‚   â”‚   â”œâ”€â”€ reference_agent.py    # å‚è€ƒå›¾é€‰å– Agent
â”‚   â”‚   â”œâ”€â”€ image_generation_agent.py  # å›¾åƒç”Ÿæˆ Agent
â”‚   â”‚   â”œâ”€â”€ consistency_agent.py  # ä¸€è‡´æ€§æ£€éªŒ Agent
â”‚   â”‚   â””â”€â”€ video_synthesis_agent.py   # è§†é¢‘åˆæˆ Agent
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ agent_routes.py       # API è·¯ç”±
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ douyin_service.py     # æŠ–éŸ³æœåŠ¡
â”œâ”€â”€ config.py                      # é…ç½®æ–‡ä»¶
â”œâ”€â”€ start_agent_system.py         # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_agent_system.py          # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ comfyui_workflow_template.py  # ComfyUI å·¥ä½œæµé…ç½®
â”œâ”€â”€ test_comfyui_connection.py    # ComfyUI è¿æ¥æµ‹è¯•
â””â”€â”€ æ–‡æ¡£/
    â”œâ”€â”€ ç³»ç»Ÿå®Œæ•´è¯´æ˜æ–‡æ¡£.md        # æœ¬æ–‡ä»¶
    â”œâ”€â”€ å¦‚ä½•è°ƒç”¨ComfyUIå·¥ä½œæµ.md
    â”œâ”€â”€ ComfyUIé›†æˆæ­¥éª¤.md
    â”œâ”€â”€ ComfyUIé›†æˆå®Œæˆè¯´æ˜.md
    â”œâ”€â”€ README_AGENT_SYSTEM.md
    â”œâ”€â”€ ARCHITECTURE.md
    â””â”€â”€ QUICK_START.md
```

---

## Agent è¯¦ç»†è¯´æ˜

### 1. BaseAgent (åŸºç±»)

**æ–‡ä»¶**: `app/agents/base_agent.py`

**ä½œç”¨**: æ‰€æœ‰ Agent çš„æŠ½è±¡åŸºç±»ï¼Œæä¾›é€šç”¨åŠŸèƒ½ã€‚

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ç»Ÿä¸€çš„æ‰§è¡Œæ¥å£ (`execute` æ–¹æ³•)
- âœ… æ—¥å¿—è®°å½• (`log_execution`)
- âœ… è¾“å…¥éªŒè¯ (`validate_input`)
- âœ… ç»“æœæ ‡å‡†åŒ– (`create_result`)

**å…³é”®æ–¹æ³•**:
```python
async def execute(input_data: Dict) -> Dict:
    """æ‰€æœ‰ Agent å¿…é¡»å®ç°çš„æ‰§è¡Œæ–¹æ³•"""
    pass

def log_execution(stage: str, data: Any):
    """è®°å½•æ‰§è¡Œæ—¥å¿—"""
    
def validate_input(input_data: Dict, required_fields: list) -> bool:
    """éªŒè¯è¾“å…¥æ•°æ®æ˜¯å¦åŒ…å«å¿…éœ€å­—æ®µ"""
    
def create_result(success: bool, data: Any, error: str) -> Dict:
    """åˆ›å»ºæ ‡å‡†åŒ–çš„è¿”å›ç»“æœ"""
```

**è¿”å›æ ¼å¼**:
```python
{
    'agent': 'AgentName',
    'success': True/False,
    'data': {...},
    'error': None,
    'timestamp': '2025-11-09T...'
}
```

---

### 2. HotspotAgent (çƒ­ç‚¹é‡‡é›†)

**æ–‡ä»¶**: `app/agents/hotspot_agent.py`

**ä½œç”¨**: ä»æŠ–éŸ³è·å–å½“å¤©çƒ­ç‚¹æ—¶è¯„ã€‚

**è¾“å…¥å‚æ•°**:
```python
{
    'keywords': ['ç§‘æŠ€', 'å¨±ä¹'],  # å¯é€‰ï¼Œå…³é”®è¯åˆ—è¡¨
    'count': 10,                   # å¯é€‰ï¼Œè·å–æ•°é‡
    'category': 'æ—¶äº‹'              # å¯é€‰ï¼Œåˆ†ç±»
}
```

**è¾“å‡ºç»“æœ**:
```python
{
    'hotspots': [                  # çƒ­ç‚¹åˆ—è¡¨
        {
            'id': 'hotspot_1',
            'title': 'çƒ­ç‚¹æ ‡é¢˜',
            'description': 'çƒ­ç‚¹æè¿°',
            'view_count': 1000000,
            'comment_count': 5000,
            'share_count': 1000,
            'category': 'æ—¶äº‹',
            'url': 'https://...'
        }
    ],
    'selected_hotspot': {...},     # é€‰ä¸­çš„çƒ­ç‚¹
    'total_count': 10
}
```

**æ ¸å¿ƒé€»è¾‘**:
1. è°ƒç”¨æŠ–éŸ³ API è·å–çƒ­ç‚¹åˆ—è¡¨
2. æ ¹æ®æµè§ˆé‡ã€è¯„è®ºæ•°ç­‰æŒ‡æ ‡ç­›é€‰
3. é€‰æ‹©æœ€åˆé€‚çš„çƒ­ç‚¹è¿”å›

**TODO**: éœ€è¦å®ç°å®é™…çš„æŠ–éŸ³ API è°ƒç”¨ã€‚

---

### 3. ScriptAgent (è„šæœ¬æ‹†è§£)

**æ–‡ä»¶**: `app/agents/script_agent.py`

**ä½œç”¨**: å°†çƒ­ç‚¹å†…å®¹æ‹†è§£æˆè§†é¢‘è„šæœ¬å’Œåœºæ™¯ã€‚

**è¾“å…¥å‚æ•°**:
```python
{
    'hotspot': {...},              # çƒ­ç‚¹ä¿¡æ¯
    'style': 'commentary',         # å¯é€‰ï¼Œè§†é¢‘é£æ ¼
    'duration': 60                 # å¯é€‰ï¼Œç›®æ ‡æ—¶é•¿ï¼ˆç§’ï¼‰
}
```

**è¾“å‡ºç»“æœ**:
```python
{
    'script': {                    # å®Œæ•´è„šæœ¬
        'title': '...',
        'theme': '...',
        'style': 'commentary',
        'duration': 60,
        'content': '...'
    },
    'scenes': [                    # åœºæ™¯åˆ—è¡¨
        {
            'scene_id': 1,
            'name': 'å¼€åœº',
            'start_time': 0,
            'end_time': 5,
            'duration': 5,
            'visual_description': 'éœ‡æ’¼çš„æ ‡é¢˜å¡',
            'narration': 'ä»Šæ—¥çƒ­ç‚¹...'
        }
    ],
    'narration': 'å®Œæ•´æ—ç™½æ–‡æœ¬',
    'total_scenes': 4
}
```

**æ ¸å¿ƒé€»è¾‘**:
1. æ ¹æ®çƒ­ç‚¹å†…å®¹ç”Ÿæˆè„šæœ¬ç»“æ„
2. ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æåœºæ™¯
3. æå–æ¯ä¸ªåœºæ™¯çš„è§†è§‰æè¿°å’Œæ—ç™½

**TODO**: å¯æ¥å…¥å¤§æ¨¡å‹ API (å¦‚ GPT-4) ç”Ÿæˆæ›´æ™ºèƒ½çš„è„šæœ¬ã€‚

---

### 4. StoryboardAgent (åˆ†é•œè§„åˆ’)

**æ–‡ä»¶**: `app/agents/storyboard_agent.py`

**ä½œç”¨**: ä¸ºæ¯ä¸ªåœºæ™¯è§„åˆ’å…·ä½“çš„é•œå¤´å’Œæ‹æ‘„å‚æ•°ã€‚

**è¾“å…¥å‚æ•°**:
```python
{
    'scenes': [...],               # åœºæ™¯åˆ—è¡¨
    'style': 'cinematic'           # å¯é€‰ï¼Œè§†è§‰é£æ ¼
}
```

**è¾“å‡ºç»“æœ**:
```python
{
    'storyboard': [                # åˆ†é•œåˆ—è¡¨
        {
            'scene_id': 1,
            'scene_name': 'å¼€åœº',
            'shots': [...],
            'shot_count': 2
        }
    ],
    'shots': [                     # æ‰€æœ‰é•œå¤´
        {
            'shot_id': 1,
            'scene_id': 1,
            'shot_type': 'wide_shot',      # é•œå¤´ç±»å‹
            'camera_angle': 'eye_level',   # æœºä½è§’åº¦
            'movement': 'static',          # é•œå¤´è¿åŠ¨
            'duration': 2.5,
            'visual_description': '...',
            'style': 'cinematic',
            'prompt': 'å®Œæ•´çš„æç¤ºè¯'        # ç”¨äºå›¾åƒç”Ÿæˆ
        }
    ],
    'total_shots': 8
}
```

**é•œå¤´ç±»å‹**:
- `wide_shot` - å…¨æ™¯é•œå¤´
- `medium_shot` - ä¸­æ™¯é•œå¤´
- `close_up` - ç‰¹å†™é•œå¤´
- `extreme_close_up` - å¤§ç‰¹å†™

**æœºä½è§’åº¦**:
- `eye_level` - å¹³è§†
- `high_angle` - ä¿¯è§†
- `low_angle` - ä»°è§†
- `dutch_angle` - è·å…°è§’

**é•œå¤´è¿åŠ¨**:
- `static` - é™æ­¢
- `pan` - æ‘‡é•œå¤´
- `tilt` - ä¿¯ä»°
- `zoom` - æ¨æ‹‰
- `dolly` - ç§»åŠ¨

**æ ¸å¿ƒé€»è¾‘**:
1. æ ¹æ®åœºæ™¯æ—¶é•¿å†³å®šé•œå¤´æ•°é‡ï¼ˆæ¯ 5 ç§’ä¸€ä¸ªé•œå¤´ï¼‰
2. æ™ºèƒ½åˆ†é…é•œå¤´ç±»å‹å’Œæœºä½
3. ç”Ÿæˆç”¨äºå›¾åƒç”Ÿæˆçš„æç¤ºè¯

---

### 5. ReferenceAgent (å‚è€ƒå›¾é€‰å–)

**æ–‡ä»¶**: `app/agents/reference_agent.py`

**ä½œç”¨**: ä¸ºæ¯ä¸ªé•œå¤´é€‰æ‹©åˆé€‚çš„å‚è€ƒå›¾ã€‚

**è¾“å…¥å‚æ•°**:
```python
{
    'shots': [...],                # é•œå¤´åˆ—è¡¨
    'reference_library': 'default' # å¯é€‰ï¼Œå‚è€ƒå›¾åº“
}
```

**è¾“å‡ºç»“æœ**:
```python
{
    'shots_with_references': [     # å¸¦å‚è€ƒå›¾çš„é•œå¤´
        {
            ...shot_data,
            'references': [
                {
                    'reference_id': 'ref_1_1',
                    'url': 'https://...',
                    'source': 'default',
                    'relevance_score': 0.95,
                    'tags': ['cinematic', 'wide_shot'],
                    'description': '...'
                }
            ]
        }
    ],
    'total_references': 16
}
```

**æ ¸å¿ƒé€»è¾‘**:
1. æ ¹æ®é•œå¤´çš„è§†è§‰æè¿°å’Œé£æ ¼æ£€ç´¢å‚è€ƒå›¾
2. ä¸ºæ¯ä¸ªé•œå¤´åŒ¹é… 1-3 å¼ å‚è€ƒå›¾
3. è®¡ç®—ç›¸å…³æ€§åˆ†æ•°

**TODO**: å¯æ¥å…¥å›¾åƒæœç´¢ API æˆ–æœ¬åœ°å›¾åº“ã€‚

---

### 6. ImageGenerationAgent (å›¾åƒç”Ÿæˆ) â­

**æ–‡ä»¶**: `app/agents/image_generation_agent.py`

**ä½œç”¨**: è°ƒç”¨ ComfyUI ç”Ÿæˆé«˜è´¨é‡å›¾åƒï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ã€‚

**è¾“å…¥å‚æ•°**:
```python
{
    'shots_with_references': [...], # å¸¦å‚è€ƒå›¾çš„é•œå¤´åˆ—è¡¨
    'workflow': {                   # ComfyUI å·¥ä½œæµé…ç½®
        'width': 1024,
        'height': 576,
        'steps': 30,
        'cfg_scale': 7.5,
        'negative_prompt': '...',
        'seed': -1
    },
    'batch_size': 1                 # æ‰¹å¤„ç†å¤§å°
}
```

**è¾“å‡ºç»“æœ**:
```python
{
    'generated_images': [           # ç”Ÿæˆçš„å›¾åƒåˆ—è¡¨
        {
            'shot_id': 1,
            'success': True,
            'image_url': 'http://127.0.0.1:8188/view?filename=...',
            'prompt': 'å®Œæ•´æç¤ºè¯',
            'prompt_id': 'comfyui_task_id',
            'references_used': ['ref_1_1', 'ref_1_2']
        }
    ],
    'total_images': 8
}
```

**æ ¸å¿ƒæ–¹æ³•**:

1. **`_build_comfyui_workflow(shot, workflow)`**
   - æ„å»º ComfyUI å·¥ä½œæµ JSON
   - ä» `comfyui_workflow_template.py` åŠ è½½é…ç½®
   - åŠ¨æ€æ³¨å…¥æç¤ºè¯ã€å°ºå¯¸ç­‰å‚æ•°

2. **`_generate_single_image(shot, workflow)`**
   - å¼‚æ­¥æäº¤ä»»åŠ¡åˆ° ComfyUI
   - å‘é€ POST è¯·æ±‚åˆ° `/prompt` ç«¯ç‚¹
   - è·å– `prompt_id`

3. **`_wait_for_completion(prompt_id, timeout=300)`**
   - è½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
   - æ¯ç§’æŸ¥è¯¢ä¸€æ¬¡ `/history/{prompt_id}`
   - ç­‰å¾…ç”Ÿæˆå®Œæˆæˆ–è¶…æ—¶

4. **`_extract_image_url(outputs)`**
   - ä» ComfyUI è¾“å‡ºä¸­æå–å›¾åƒ URL
   - æ”¯æŒå¤šç§è¾“å‡ºèŠ‚ç‚¹ ID
   - æ„å»ºå®Œæ•´çš„å›¾åƒè®¿é—® URL

**å·¥ä½œæµç¨‹**:
```
1. åŠ è½½å·¥ä½œæµé…ç½®
   â†“
2. æ³¨å…¥åŠ¨æ€å‚æ•°ï¼ˆæç¤ºè¯ã€å°ºå¯¸ç­‰ï¼‰
   â†“
3. POST /prompt æäº¤ä»»åŠ¡
   â†“
4. è·å– prompt_id
   â†“
5. è½®è¯¢ GET /history/{prompt_id}
   â†“
6. æ£€æŸ¥ status.completed
   â†“
7. æå–å›¾åƒ URL
   â†“
8. è¿”å›ç»“æœ
```

**é…ç½®æ–‡ä»¶**: `comfyui_workflow_template.py`
- éœ€è¦å¡«å…… `COMFYUI_WORKFLOW` å­—å…¸
- é…ç½® `DYNAMIC_NODES` èŠ‚ç‚¹ ID
- ä½¿ç”¨ `get_workflow_with_params()` å‡½æ•°

**ç‰¹æ€§**:
- âœ… å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… æ”¯æŒæ‰¹é‡ç”Ÿæˆ
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶

---

### 7. ConsistencyAgent (ä¸€è‡´æ€§æ£€éªŒ)

**æ–‡ä»¶**: `app/agents/consistency_agent.py`

**ä½œç”¨**: æ£€æŸ¥ç”Ÿæˆå›¾åƒçš„ä¸€è‡´æ€§å’Œè´¨é‡ã€‚

**è¾“å…¥å‚æ•°**:
```python
{
    'generated_images': [...],      # ç”Ÿæˆçš„å›¾åƒåˆ—è¡¨
    'storyboard': [...]             # åˆ†é•œä¿¡æ¯
}
```

**è¾“å‡ºç»“æœ**:
```python
{
    'consistency_report': {         # ä¸€è‡´æ€§æŠ¥å‘Š
        'style_consistency': {
            'score': 0.92,
            'issues': [],
            'details': 'é£æ ¼æ•´ä½“ä¸€è‡´'
        },
        'character_consistency': {
            'score': 0.88,
            'issues': ['é•œå¤´3å’Œé•œå¤´7çš„è§’è‰²å¤–è§‚ç•¥æœ‰å·®å¼‚'],
            'details': 'è§’è‰²åŸºæœ¬ä¸€è‡´'
        },
        'scene_consistency': {
            'score': 0.90,
            'issues': [],
            'details': 'åœºæ™¯è¿‡æ¸¡è‡ªç„¶'
        },
        'quality_check': {
            'score': 0.95,
            'issues': [],
            'details': 'å›¾åƒè´¨é‡è‰¯å¥½'
        }
    },
    'passed_images': [...],         # é€šè¿‡æ£€éªŒçš„å›¾åƒ
    'failed_images': [...],         # æœªé€šè¿‡æ£€éªŒçš„å›¾åƒ
    'overall_score': 0.91,
    'pass_rate': 0.875              # é€šè¿‡ç‡ 87.5%
}
```

**æ£€æŸ¥é¡¹ç›®**:
1. **é£æ ¼ä¸€è‡´æ€§** - æ£€æŸ¥æ‰€æœ‰å›¾åƒçš„è§†è§‰é£æ ¼æ˜¯å¦ç»Ÿä¸€
2. **è§’è‰²ä¸€è‡´æ€§** - æ£€æŸ¥è§’è‰²å¤–è§‚æ˜¯å¦ä¿æŒä¸€è‡´
3. **åœºæ™¯ä¸€è‡´æ€§** - æ£€æŸ¥åœºæ™¯è¿‡æ¸¡æ˜¯å¦è‡ªç„¶
4. **è´¨é‡æ£€æŸ¥** - æ£€æŸ¥å›¾åƒåˆ†è¾¨ç‡ã€æ¸…æ™°åº¦ç­‰

**æ ¸å¿ƒé€»è¾‘**:
1. å¯¹æ¯å¼ å›¾åƒè¿›è¡Œå¤šç»´åº¦è¯„åˆ†
2. è®¡ç®—ç»¼åˆä¸€è‡´æ€§åˆ†æ•°
3. æ ¹æ®é˜ˆå€¼ï¼ˆé»˜è®¤ 0.8ï¼‰åˆ†ç±»å›¾åƒ
4. ç”Ÿæˆè¯¦ç»†çš„æ£€éªŒæŠ¥å‘Š

**TODO**: å¯æ¥å…¥å›¾åƒåˆ†æ API è¿›è¡Œæ›´ç²¾ç¡®çš„æ£€æµ‹ã€‚

---

### 8. VideoSynthesisAgent (è§†é¢‘åˆæˆ)

**æ–‡ä»¶**: `app/agents/video_synthesis_agent.py`

**ä½œç”¨**: å°†æ‰€æœ‰ç´ æåˆæˆæœ€ç»ˆè§†é¢‘ã€‚

**è¾“å…¥å‚æ•°**:
```python
{
    'passed_images': [...],         # é€šè¿‡æ£€éªŒçš„å›¾åƒ
    'narration_audio': 'path/to/audio.mp3',  # å¯é€‰ï¼Œæ—ç™½éŸ³é¢‘
    'background_music': 'path/to/music.mp3', # å¯é€‰ï¼ŒèƒŒæ™¯éŸ³ä¹
    'output_filename': 'final_video.mp4'     # å¯é€‰ï¼Œè¾“å‡ºæ–‡ä»¶å
}
```

**è¾“å‡ºç»“æœ**:
```python
{
    'video_path': 'output/videos/final_video.mp4',
    'duration': 60.5,
    'resolution': '1920x1080',
    'fps': 30
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
1. å°†å›¾åƒåºåˆ—è½¬æ¢ä¸ºè§†é¢‘ç‰‡æ®µ
2. æ·»åŠ æ—ç™½éŸ³é¢‘
3. æ·»åŠ èƒŒæ™¯éŸ³ä¹
4. æ·»åŠ è½¬åœºæ•ˆæœ
5. å¯¼å‡ºæœ€ç»ˆè§†é¢‘

**ä½¿ç”¨çš„åº“**: MoviePy

**TODO**: éœ€è¦å®ç°å®é™…çš„è§†é¢‘åˆæˆé€»è¾‘ã€‚

---

### 9. VideoCreationOrchestrator (æµç¨‹ç¼–æ’å™¨) â­

**æ–‡ä»¶**: `app/agents/orchestrator.py`

**ä½œç”¨**: ç»Ÿä¸€åè°ƒå’Œç®¡ç†æ‰€æœ‰ Agent çš„æ‰§è¡Œï¼ˆæ ¸å¿ƒæ§åˆ¶å™¨ï¼‰ã€‚

**è¾“å…¥å‚æ•°**:
```python
{
    'keywords': ['ç§‘æŠ€', 'AI'],     # å¯é€‰ï¼Œçƒ­ç‚¹å…³é”®è¯
    'style': 'cinematic',           # å¯é€‰ï¼Œè§†é¢‘é£æ ¼
    'duration': 60,                 # å¯é€‰ï¼Œç›®æ ‡æ—¶é•¿
    'comfyui_workflow': {...},      # å¯é€‰ï¼ŒComfyUI é…ç½®
    'reference_library': 'default', # å¯é€‰ï¼Œå‚è€ƒå›¾åº“
    'batch_size': 1,                # å¯é€‰ï¼Œæ‰¹å¤„ç†å¤§å°
    'retry_failed': True,           # å¯é€‰ï¼Œæ˜¯å¦é‡è¯•å¤±è´¥çš„å›¾åƒ
    'narration_audio': '...',       # å¯é€‰ï¼Œæ—ç™½éŸ³é¢‘
    'background_music': '...',      # å¯é€‰ï¼ŒèƒŒæ™¯éŸ³ä¹
    'output_filename': 'video.mp4'  # å¯é€‰ï¼Œè¾“å‡ºæ–‡ä»¶å
}
```

**è¾“å‡ºç»“æœ**:
```python
{
    'success': True,
    'stages': {                     # æ¯ä¸ªé˜¶æ®µçš„è¯¦ç»†ç»“æœ
        'hotspot': {...},
        'script': {...},
        'storyboard': {...},
        'reference': {...},
        'generation': {...},
        'consistency': {...},
        'synthesis': {...}
    },
    'final_video': 'output/videos/final_video.mp4',
    'errors': []
}
```

**æ‰§è¡Œæµç¨‹**:
```
1. HotspotAgent      â†’ è·å–çƒ­ç‚¹
2. ScriptAgent       â†’ ç”Ÿæˆè„šæœ¬
3. StoryboardAgent   â†’ è§„åˆ’åˆ†é•œ
4. ReferenceAgent    â†’ é€‰æ‹©å‚è€ƒå›¾
5. ImageGenerationAgent â†’ ç”Ÿæˆå›¾åƒ
6. ConsistencyAgent  â†’ æ£€éªŒä¸€è‡´æ€§
7. VideoSynthesisAgent  â†’ åˆæˆè§†é¢‘
```

**æ ¸å¿ƒæ–¹æ³•**:

1. **`create_video(input_params)`**
   - æ‰§è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµç¨‹
   - æŒ‰é¡ºåºè°ƒç”¨æ‰€æœ‰ Agent
   - å¤„ç†æ¯ä¸ªé˜¶æ®µçš„é”™è¯¯
   - è¿”å›å®Œæ•´çš„æ‰§è¡Œç»“æœ

2. **`_handle_error(stage, error_result, result)`**
   - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
   - è®°å½•å¤±è´¥çš„é˜¶æ®µ
   - è¿”å›éƒ¨åˆ†ç»“æœ

3. **`get_stage_status()`**
   - è·å–æ‰€æœ‰ Agent çš„çŠ¶æ€
   - ç”¨äºå¥åº·æ£€æŸ¥

**ç‰¹æ€§**:
- âœ… ç«¯åˆ°ç«¯è‡ªåŠ¨åŒ–
- âœ… é˜¶æ®µåŒ–æ‰§è¡Œ
- âœ… é”™è¯¯éš”ç¦»
- âœ… è¯¦ç»†æ—¥å¿—
- âœ… æ”¯æŒé‡è¯•

---

## å®Œæ•´å·¥ä½œæµç¨‹

### ç«¯åˆ°ç«¯æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥
  â”‚
  â”œâ”€ keywords: ['ç§‘æŠ€', 'AI']
  â”œâ”€ style: 'cinematic'
  â”œâ”€ duration: 60
  â””â”€ comfyui_workflow: {...}
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 1: çƒ­ç‚¹é‡‡é›† (HotspotAgent)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è°ƒç”¨æŠ–éŸ³ API                       â”‚
â”‚ â€¢ è·å–çƒ­ç‚¹åˆ—è¡¨                       â”‚
â”‚ â€¢ é€‰æ‹©æœ€ä½³çƒ­ç‚¹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ selected_hotspot
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 2: è„šæœ¬æ‹†è§£ (ScriptAgent)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç”Ÿæˆè§†é¢‘è„šæœ¬                       â”‚
â”‚ â€¢ æ‹†è§£åœºæ™¯                          â”‚
â”‚ â€¢ æå–æ—ç™½                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ scenes (4ä¸ªåœºæ™¯)
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 3: åˆ†é•œè§„åˆ’ (StoryboardAgent)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ä¸ºæ¯ä¸ªåœºæ™¯è§„åˆ’é•œå¤´                 â”‚
â”‚ â€¢ ç¡®å®šé•œå¤´ç±»å‹å’Œæœºä½                 â”‚
â”‚ â€¢ ç”Ÿæˆå›¾åƒæç¤ºè¯                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ shots (8ä¸ªé•œå¤´)
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 4: å‚è€ƒå›¾é€‰å– (ReferenceAgent)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ä¸ºæ¯ä¸ªé•œå¤´åŒ¹é…å‚è€ƒå›¾               â”‚
â”‚ â€¢ è®¡ç®—ç›¸å…³æ€§åˆ†æ•°                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ shots_with_references
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 5: å›¾åƒç”Ÿæˆ (ImageGeneration)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ„å»º ComfyUI å·¥ä½œæµ                â”‚
â”‚ â€¢ æäº¤ç”Ÿæˆä»»åŠ¡                       â”‚
â”‚ â€¢ ç­‰å¾…ç”Ÿæˆå®Œæˆ                       â”‚
â”‚ â€¢ è·å–å›¾åƒ URL                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ generated_images (8å¼ )
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 6: ä¸€è‡´æ€§æ£€éªŒ (ConsistencyAgent)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ£€æŸ¥é£æ ¼ä¸€è‡´æ€§                     â”‚
â”‚ â€¢ æ£€æŸ¥è§’è‰²ä¸€è‡´æ€§                     â”‚
â”‚ â€¢ æ£€æŸ¥åœºæ™¯ä¸€è‡´æ€§                     â”‚
â”‚ â€¢ æ£€æŸ¥å›¾åƒè´¨é‡                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ passed_images (7å¼ é€šè¿‡)
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 7: è§†é¢‘åˆæˆ (VideoSynthesis)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ å›¾åƒåºåˆ—è½¬è§†é¢‘                     â”‚
â”‚ â€¢ æ·»åŠ æ—ç™½éŸ³é¢‘                       â”‚
â”‚ â€¢ æ·»åŠ èƒŒæ™¯éŸ³ä¹                       â”‚
â”‚ â€¢ æ·»åŠ è½¬åœºæ•ˆæœ                       â”‚
â”‚ â€¢ å¯¼å‡ºæœ€ç»ˆè§†é¢‘                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      final_video.mp4
```

### æ•°æ®æµè½¬ç¤ºä¾‹

**è¾“å…¥**:
```python
{
    'keywords': ['äººå·¥æ™ºèƒ½', 'ç§‘æŠ€'],
    'style': 'cinematic',
    'duration': 60
}
```

**é˜¶æ®µ 1 è¾“å‡º** (çƒ­ç‚¹):
```python
{
    'selected_hotspot': {
        'title': 'AI æŠ€æœ¯çªç ´ï¼šGPT-5 å‘å¸ƒ',
        'description': 'æœ€æ–°çš„ AI æ¨¡å‹...'
    }
}
```

**é˜¶æ®µ 2 è¾“å‡º** (è„šæœ¬):
```python
{
    'scenes': [
        {'scene_id': 1, 'name': 'å¼€åœº', 'duration': 5},
        {'scene_id': 2, 'name': 'ä¸»ä½“1', 'duration': 15},
        {'scene_id': 3, 'name': 'ä¸»ä½“2', 'duration': 20},
        {'scene_id': 4, 'name': 'ç»“å°¾', 'duration': 20}
    ]
}
```

**é˜¶æ®µ 3 è¾“å‡º** (åˆ†é•œ):
```python
{
    'shots': [
        {'shot_id': 1, 'prompt': 'cinematic style, wide shot...'},
        {'shot_id': 2, 'prompt': 'cinematic style, close up...'},
        # ... å…± 8 ä¸ªé•œå¤´
    ]
}
```

**é˜¶æ®µ 5 è¾“å‡º** (å›¾åƒ):
```python
{
    'generated_images': [
        {
            'shot_id': 1,
            'image_url': 'http://127.0.0.1:8188/view?filename=shot_1.png'
        },
        # ... å…± 8 å¼ å›¾åƒ
    ]
}
```

**æœ€ç»ˆè¾“å‡º**:
```python
{
    'success': True,
    'final_video': 'output/videos/final_video.mp4',
    'duration': 60.5
}
```

---

## ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. å®‰è£…ä¾èµ–

```bash
cd backend
pip install -r requirements.txt
```

#### 2. é…ç½® ComfyUI

ç¼–è¾‘ `comfyui_workflow_template.py`:

```python
COMFYUI_WORKFLOW = {
    # ç²˜è´´ä» ComfyUI å¯¼å‡ºçš„å·¥ä½œæµ JSON
}

DYNAMIC_NODES = {
    "positive_prompt_node": "6",
    "negative_prompt_node": "7",
    "save_image_node": "9",
    "seed_node": "3",
    "size_node": "5",
}
```

#### 3. å¯åŠ¨ ComfyUI

```bash
cd ComfyUI
python main.py
```

#### 4. æµ‹è¯•è¿æ¥

```bash
cd backend
python test_comfyui_connection.py
```

#### 5. å¯åŠ¨ Agent ç³»ç»Ÿ

```bash
python start_agent_system.py
```

æœåŠ¡å°†åœ¨ `http://localhost:8000` å¯åŠ¨ã€‚

---

### ä½¿ç”¨æ–¹å¼

#### æ–¹å¼ 1: é€šè¿‡ HTTP API

**ç«¯ç‚¹**: `POST /api/agent/create-video`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST http://localhost:8000/api/agent/create-video \
  -H "Content-Type: application/json" \
  -d '{
    "keywords": ["äººå·¥æ™ºèƒ½", "ç§‘æŠ€"],
    "style": "cinematic",
    "duration": 60,
    "comfyui_workflow": {
      "width": 1024,
      "height": 576,
      "steps": 30,
      "cfg_scale": 7.5
    }
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "stages": {
    "hotspot": {...},
    "script": {...},
    "storyboard": {...},
    "reference": {...},
    "generation": {...},
    "consistency": {...},
    "synthesis": {...}
  },
  "final_video": "output/videos/final_video.mp4"
}
```

#### æ–¹å¼ 2: é€šè¿‡ Python ä»£ç 

```python
import asyncio
from app.agents.orchestrator import VideoCreationOrchestrator

async def create_video():
    orchestrator = VideoCreationOrchestrator({
        'comfyui_url': 'http://127.0.0.1:8188'
    })
    
    result = await orchestrator.create_video({
        'keywords': ['äººå·¥æ™ºèƒ½', 'ç§‘æŠ€'],
        'style': 'cinematic',
        'duration': 60,
        'comfyui_workflow': {
            'width': 1024,
            'height': 576,
            'steps': 30
        }
    })
    
    print(f"è§†é¢‘ç”Ÿæˆå®Œæˆ: {result['final_video']}")

asyncio.run(create_video())
```

#### æ–¹å¼ 3: å•ç‹¬è°ƒç”¨æŸä¸ª Agent

```python
from app.agents.image_generation_agent import ImageGenerationAgent

async def generate_images():
    agent = ImageGenerationAgent({
        'comfyui_url': 'http://127.0.0.1:8188'
    })
    
    result = await agent.execute({
        'shots_with_references': [
            {
                'shot_id': 1,
                'prompt': 'ç”µå½±é£æ ¼ï¼ŒåŸå¸‚å¤œæ™¯',
                'references': []
            }
        ],
        'workflow': {
            'width': 1024,
            'height': 576,
            'steps': 30
        }
    })
    
    print(result)

asyncio.run(generate_images())
```

---

### æµ‹è¯•

#### æµ‹è¯• ComfyUI è¿æ¥

```bash
python test_comfyui_connection.py
```

è¿™ä¼šæµ‹è¯•ï¼š
1. âœ“ ComfyUI è¿æ¥
2. âœ“ å·¥ä½œæµé…ç½®
3. âœ“ ä»»åŠ¡æäº¤ï¼ˆå¯é€‰ï¼‰

#### æµ‹è¯• Agent ç³»ç»Ÿ

```bash
python test_agent_system.py
```

è¿™ä¼šæµ‹è¯•æ‰€æœ‰ Agent çš„åŸºæœ¬åŠŸèƒ½ã€‚

---

## API æ¥å£

### 1. åˆ›å»ºè§†é¢‘ï¼ˆç«¯åˆ°ç«¯ï¼‰

**ç«¯ç‚¹**: `POST /api/agent/create-video`

**è¯·æ±‚ä½“**:
```json
{
  "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"],
  "style": "cinematic",
  "duration": 60,
  "comfyui_workflow": {
    "width": 1024,
    "height": 576,
    "steps": 30,
    "cfg_scale": 7.5,
    "negative_prompt": "low quality, blurry",
    "seed": -1
  },
  "reference_library": "default",
  "batch_size": 1,
  "retry_failed": true,
  "output_filename": "my_video.mp4"
}
```

**å“åº”**:
```json
{
  "success": true,
  "stages": {
    "hotspot": {...},
    "script": {...},
    "storyboard": {...},
    "reference": {...},
    "generation": {...},
    "consistency": {...},
    "synthesis": {...}
  },
  "final_video": "output/videos/my_video.mp4"
}
```

### 2. æ‰§è¡Œå•ä¸ª Agent

**ç«¯ç‚¹**: `POST /api/agent/execute`

**è¯·æ±‚ä½“**:
```json
{
  "agent_name": "ImageGenerationAgent",
  "input_data": {
    "shots_with_references": [...],
    "workflow": {...}
  }
}
```

**å“åº”**:
```json
{
  "agent": "ImageGenerationAgent",
  "success": true,
  "data": {...},
  "error": null,
  "timestamp": "2025-11-09T..."
}
```

### 3. è·å–ç³»ç»ŸçŠ¶æ€

**ç«¯ç‚¹**: `GET /api/agent/status`

**å“åº”**:
```json
{
  "agents": [
    {"name": "HotspotAgent", "status": "ready"},
    {"name": "ScriptAgent", "status": "ready"},
    {"name": "ImageGenerationAgent", "status": "ready"},
    ...
  ]
}
```

### 4. å¥åº·æ£€æŸ¥

**ç«¯ç‚¹**: `GET /health`

**å“åº”**:
```json
{
  "status": "healthy",
  "timestamp": "2025-11-09T..."
}
```

---

## é…ç½®è¯´æ˜

### 1. ç³»ç»Ÿé…ç½® (`config.py`)

```python
# ComfyUI é…ç½®
COMFYUI_URL = "http://127.0.0.1:8188"

# è¾“å‡ºç›®å½•
OUTPUT_DIR = "output/videos"

# æ—¥å¿—é…ç½®
LOG_LEVEL = "INFO"
LOG_FILE = "logs/agent_system.log"

# Agent é…ç½®
AGENT_CONFIG = {
    'consistency_threshold': 0.8,  # ä¸€è‡´æ€§é˜ˆå€¼
    'max_retries': 3,              # æœ€å¤§é‡è¯•æ¬¡æ•°
    'timeout': 300                 # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
}
```

### 2. ComfyUI å·¥ä½œæµé…ç½® (`comfyui_workflow_template.py`)

**å¿…é¡»é…ç½®çš„éƒ¨åˆ†**:

```python
# 1. å·¥ä½œæµ JSONï¼ˆä» ComfyUI å¯¼å‡ºï¼‰
COMFYUI_WORKFLOW = {
    "3": {...},
    "4": {...},
    # ... ä½ çš„å·¥ä½œæµèŠ‚ç‚¹
}

# 2. åŠ¨æ€èŠ‚ç‚¹ ID
DYNAMIC_NODES = {
    "positive_prompt_node": "6",   # æ­£å‘æç¤ºè¯èŠ‚ç‚¹
    "negative_prompt_node": "7",   # è´Ÿå‘æç¤ºè¯èŠ‚ç‚¹
    "save_image_node": "9",        # ä¿å­˜å›¾åƒèŠ‚ç‚¹
    "seed_node": "3",              # ç§å­èŠ‚ç‚¹
    "size_node": "5",              # å°ºå¯¸èŠ‚ç‚¹
}

# 3. é»˜è®¤å‚æ•°
DEFAULT_PARAMS = {
    "width": 1024,
    "height": 576,
    "steps": 30,
    "cfg_scale": 7.5,
    "negative_prompt": "low quality, blurry, distorted",
}
```

### 3. ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# ComfyUI
COMFYUI_URL=http://127.0.0.1:8188

# æŠ–éŸ³ APIï¼ˆå¦‚æœæœ‰ï¼‰
DOUYIN_API_KEY=your_api_key
DOUYIN_API_SECRET=your_api_secret

# å¤§æ¨¡å‹ APIï¼ˆå¦‚æœä½¿ç”¨ï¼‰
OPENAI_API_KEY=your_openai_key

# æœåŠ¡å™¨
HOST=0.0.0.0
PORT=8000
```

---

## æ–‡ä»¶è¯¦ç»†è¯´æ˜

### æ ¸å¿ƒ Agent æ–‡ä»¶

| æ–‡ä»¶ | è¡Œæ•° | ä½œç”¨ | çŠ¶æ€ |
|------|------|------|------|
| `base_agent.py` | ~60 | Agent åŸºç±»ï¼Œæä¾›é€šç”¨åŠŸèƒ½ | âœ… å®Œæˆ |
| `orchestrator.py` | ~200 | æµç¨‹ç¼–æ’å™¨ï¼Œåè°ƒæ‰€æœ‰ Agent | âœ… å®Œæˆ |
| `hotspot_agent.py` | ~80 | çƒ­ç‚¹é‡‡é›† | âš ï¸ éœ€å®ç° API |
| `script_agent.py` | ~120 | è„šæœ¬æ‹†è§£ | âš ï¸ å¯æ¥å…¥å¤§æ¨¡å‹ |
| `storyboard_agent.py` | ~100 | åˆ†é•œè§„åˆ’ | âœ… å®Œæˆ |
| `reference_agent.py` | ~80 | å‚è€ƒå›¾é€‰å– | âš ï¸ éœ€å®ç°æ£€ç´¢ |
| `image_generation_agent.py` | ~250 | å›¾åƒç”Ÿæˆï¼ˆComfyUIï¼‰ | âœ… å®Œæˆ |
| `consistency_agent.py` | ~120 | ä¸€è‡´æ€§æ£€éªŒ | âš ï¸ å¯æ¥å…¥åˆ†æ API |
| `video_synthesis_agent.py` | ~100 | è§†é¢‘åˆæˆ | âš ï¸ éœ€å®ç°åˆæˆ |

### é…ç½®å’Œå·¥å…·æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ | çŠ¶æ€ |
|------|------|------|
| `config.py` | ç³»ç»Ÿé…ç½® | âœ… å®Œæˆ |
| `comfyui_workflow_template.py` | ComfyUI å·¥ä½œæµé…ç½® | âš ï¸ éœ€å¡«å…… |
| `start_agent_system.py` | å¯åŠ¨è„šæœ¬ | âœ… å®Œæˆ |
| `test_agent_system.py` | æµ‹è¯•è„šæœ¬ | âœ… å®Œæˆ |
| `test_comfyui_connection.py` | ComfyUI è¿æ¥æµ‹è¯• | âœ… å®Œæˆ |

### æ–‡æ¡£æ–‡ä»¶

| æ–‡ä»¶ | å†…å®¹ |
|------|------|
| `ç³»ç»Ÿå®Œæ•´è¯´æ˜æ–‡æ¡£.md` | æœ¬æ–‡ä»¶ï¼Œå®Œæ•´çš„ç³»ç»Ÿè¯´æ˜ |
| `å¦‚ä½•è°ƒç”¨ComfyUIå·¥ä½œæµ.md` | ComfyUI æŠ€æœ¯ç»†èŠ‚ |
| `ComfyUIé›†æˆæ­¥éª¤.md` | ComfyUI å¿«é€Ÿå¼€å§‹ |
| `ComfyUIé›†æˆå®Œæˆè¯´æ˜.md` | ComfyUI é›†æˆæ€»ç»“ |
| `README_AGENT_SYSTEM.md` | Agent ç³»ç»Ÿè¯´æ˜ |
| `ARCHITECTURE.md` | æ¶æ„æ–‡æ¡£ |
| `QUICK_START.md` | å¿«é€Ÿå¼€å§‹æŒ‡å— |

---

## ç³»ç»Ÿç‰¹æ€§

### âœ… å·²å®ç°çš„åŠŸèƒ½

1. **å®Œæ•´çš„ Agent æ¶æ„**
   - ç»Ÿä¸€çš„åŸºç±»å’Œæ¥å£
   - æ ‡å‡†åŒ–çš„è¾“å…¥è¾“å‡º
   - å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ

2. **ç«¯åˆ°ç«¯æµç¨‹ç¼–æ’**
   - 7 ä¸ªé˜¶æ®µçš„è‡ªåŠ¨åŒ–æµç¨‹
   - é˜¶æ®µé—´æ•°æ®ä¼ é€’
   - é”™è¯¯éš”ç¦»å’Œå¤„ç†

3. **ComfyUI é›†æˆ**
   - å¼‚æ­¥ API è°ƒç”¨
   - è½®è¯¢ç­‰å¾…æœºåˆ¶
   - è‡ªåŠ¨æå–å›¾åƒ URL
   - çµæ´»çš„å·¥ä½œæµé…ç½®

4. **HTTP API æ¥å£**
   - RESTful API è®¾è®¡
   - å®Œæ•´çš„è¯·æ±‚å“åº”
   - å¥åº·æ£€æŸ¥ç«¯ç‚¹

5. **æµ‹è¯•å·¥å…·**
   - è¿æ¥æµ‹è¯•è„šæœ¬
   - Agent åŠŸèƒ½æµ‹è¯•
   - ç«¯åˆ°ç«¯æµ‹è¯•

### âš ï¸ éœ€è¦å®ç°çš„åŠŸèƒ½

1. **æŠ–éŸ³ API é›†æˆ**
   - å®é™…çš„çƒ­ç‚¹æ•°æ®è·å–
   - API è®¤è¯å’Œè°ƒç”¨

2. **å¤§æ¨¡å‹é›†æˆ**
   - è„šæœ¬ç”Ÿæˆï¼ˆGPT-4 ç­‰ï¼‰
   - æç¤ºè¯ä¼˜åŒ–

3. **å›¾åƒæ£€ç´¢**
   - å‚è€ƒå›¾æœç´¢ API
   - æœ¬åœ°å›¾åº“ç®¡ç†

4. **å›¾åƒåˆ†æ**
   - ä¸€è‡´æ€§æ£€æµ‹ç®—æ³•
   - è´¨é‡è¯„ä¼°æ¨¡å‹

5. **è§†é¢‘åˆæˆ**
   - MoviePy å®ç°
   - è½¬åœºæ•ˆæœ
   - éŸ³é¢‘æ··åˆ

---

## æ‰©å±•å’Œå®šåˆ¶

### æ·»åŠ æ–°çš„ Agent

1. åˆ›å»ºæ–°æ–‡ä»¶ `app/agents/my_agent.py`
2. ç»§æ‰¿ `BaseAgent` ç±»
3. å®ç° `execute` æ–¹æ³•
4. åœ¨ `orchestrator.py` ä¸­é›†æˆ

```python
from .base_agent import BaseAgent

class MyAgent(BaseAgent):
    def __init__(self, config=None):
        super().__init__("MyAgent", config)
    
    async def execute(self, input_data):
        # å®ç°ä½ çš„é€»è¾‘
        return self.create_result(True, {...})
```

### è‡ªå®šä¹‰å·¥ä½œæµ

ä¿®æ”¹ `comfyui_workflow_template.py`:

```python
def get_custom_workflow(prompt, **kwargs):
    workflow = COMFYUI_WORKFLOW.copy()
    
    # è‡ªå®šä¹‰ä¿®æ”¹
    workflow["6"]["inputs"]["text"] = prompt
    workflow["3"]["inputs"]["steps"] = kwargs.get('steps', 30)
    
    return workflow
```

### æ·»åŠ æ–°çš„ API ç«¯ç‚¹

åœ¨ `app/routes/agent_routes.py` ä¸­æ·»åŠ :

```python
@router.post("/my-endpoint")
async def my_endpoint(request: MyRequest):
    # å¤„ç†è¯·æ±‚
    return {"result": "..."}
```

---

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q1: ComfyUI è¿æ¥å¤±è´¥**
```
é”™è¯¯: æ— æ³•è¿æ¥åˆ° ComfyUI
è§£å†³: 
1. ç¡®ä¿ ComfyUI æ­£åœ¨è¿è¡Œ
2. æ£€æŸ¥ç«¯å£æ˜¯å¦æ˜¯ 8188
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
```

**Q2: å·¥ä½œæµæœªé…ç½®**
```
é”™è¯¯: ComfyUI å·¥ä½œæµæœªé…ç½®
è§£å†³: åœ¨ comfyui_workflow_template.py ä¸­å¡«å…… COMFYUI_WORKFLOW
```

**Q3: å›¾åƒç”Ÿæˆè¶…æ—¶**
```
é”™è¯¯: ä»»åŠ¡ç”Ÿæˆè¶…æ—¶
è§£å†³:
1. å‡å°‘é‡‡æ ·æ­¥æ•°
2. é™ä½å›¾åƒåˆ†è¾¨ç‡
3. å¢åŠ è¶…æ—¶æ—¶é—´
```

**Q4: æ— æ³•æå–å›¾åƒ**
```
é”™è¯¯: æ— æ³•ä» ComfyUI è¾“å‡ºä¸­æå–å›¾åƒ
è§£å†³: æ£€æŸ¥ DYNAMIC_NODES["save_image_node"] é…ç½®
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/agent_system.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep ERROR logs/agent_system.log
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡å¤„ç†

```python
result = await orchestrator.create_video({
    'batch_size': 4  # åŒæ—¶å¤„ç† 4 ä¸ªé•œå¤´
})
```

### 2. å¹¶å‘ç”Ÿæˆ

ä¿®æ”¹ `image_generation_agent.py`:

```python
async def _generate_batch(self, shots, workflow):
    tasks = [self._generate_single_image(shot, workflow) for shot in shots]
    return await asyncio.gather(*tasks)
```

### 3. ç¼“å­˜æœºåˆ¶

æ·»åŠ ç»“æœç¼“å­˜:

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_cached_result(key):
    # è¿”å›ç¼“å­˜çš„ç»“æœ
    pass
```

---

## æ€»ç»“

### ç³»ç»Ÿäº®ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡** - æ¯ä¸ª Agent ç‹¬ç«‹ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
2. **å¼‚æ­¥å¤„ç†** - é«˜æ€§èƒ½ï¼Œä¸é˜»å¡
3. **å®Œæ•´æµç¨‹** - ä»çƒ­ç‚¹åˆ°è§†é¢‘çš„ç«¯åˆ°ç«¯è‡ªåŠ¨åŒ–
4. **çµæ´»é…ç½®** - æ”¯æŒè‡ªå®šä¹‰å·¥ä½œæµå’Œå‚æ•°
5. **è¯¦ç»†æ—¥å¿—** - å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿï¼Œä¾¿äºè°ƒè¯•
6. **é”™è¯¯å¤„ç†** - å®Œæ•´çš„å¼‚å¸¸æ•è·å’Œé”™è¯¯ä¿¡æ¯

### ä¸‹ä¸€æ­¥è®¡åˆ’

1. âœ… å®Œæˆ ComfyUI å·¥ä½œæµé…ç½®
2. âš ï¸ å®ç°æŠ–éŸ³ API é›†æˆ
3. âš ï¸ æ¥å…¥å¤§æ¨¡å‹ API
4. âš ï¸ å®ç°è§†é¢‘åˆæˆåŠŸèƒ½
5. âš ï¸ æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹
6. âš ï¸ æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§

### è”ç³»å’Œæ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- `å¦‚ä½•è°ƒç”¨ComfyUIå·¥ä½œæµ.md` - ComfyUI è¯¦ç»†è¯´æ˜
- `ComfyUIé›†æˆæ­¥éª¤.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
- `QUICK_START.md` - ç³»ç»Ÿå¿«é€Ÿå¼€å§‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-09  
**ä½œè€…**: AI Video Creation Team
