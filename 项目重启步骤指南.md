# 完整项目重启步骤指南

## 1. 准备工作

### 1.1 激活虚拟环境
```bash
# 切换到项目根目录
cd d:\ai-agent-comfy

# 激活虚拟环境
venv\Scripts\activate
```

### 1.2 停止所有现有Python进程
确保没有残留的Python进程影响启动：
```bash
taskkill /F /IM python.exe /T
```

## 2. 启动核心服务（按顺序执行）

### 2.1 启动ComfyUI服务（AI生成核心）
```bash
# 切换到ComfyUI目录
cd D:\ComfyUI-master

# 使用GPU加速启动ComfyUI
python main.py --normalvram --cuda-device 0 --disable-xformers
```
- 等待服务启动完成（约30秒-1分钟）
- 服务将运行在：http://127.0.0.1:8188
- 首次启动会自动下载模型文件，耐心等待

### 2.2 验证ComfyUI启动状态
```bash
# 返回项目根目录
cd d:\ai-agent-comfy

# 检查ComfyUI是否正常响应
python check_comfyui.py
# 预期输出：✅ ComfyUI服务正常响应
```

### 2.3 启动抖音爬虫服务
```bash
# 切换到爬虫目录
cd backend/crawler/Douyin_TikTok_Download_API-main

# 启动爬虫服务
python start.py
```
- 爬虫服务运行在：http://127.0.0.1:8000
- 用于获取抖音热点数据

### 2.4 启动后端服务（可选）
如果需要使用API服务，可启动后端：
```bash
# 切换到后端目录
cd d:\ai-agent-comfy\backend

# 启动后端服务
python run.py
```
- 后端服务运行在：http://0.0.0.0:5000

## 3. 运行视频生成测试
```bash
# 返回项目根目录
cd d:\ai-agent-comfy

# 运行视频生成脚本
python generate_video.py
```
- 脚本将自动执行完整的视频生成流程
- 包括：热点获取、脚本拆解、分镜规划、关键帧生成、视频合成

## 4. 监控与验证

### 4.1 监控GPU利用率
```bash
# 实时监控GPU使用情况
nvidia-smi -l 1
```
- 观察"GPU-Util"列，正常情况下应达到50%-95%
- 观察"Memory-Usage"列，确保有足够的VRAM可用

### 4.2 监控服务日志
- **ComfyUI日志**：在ComfyUI启动的终端查看
- **爬虫服务日志**：在爬虫服务启动的终端查看
- **视频生成日志**：在运行`generate_video.py`的终端查看
- **日志文件**：查看`logs/`目录下的日志文件

## 5. 常见问题排查

### 5.1 ComfyUI启动失败
- 检查端口8188是否被占用
- 检查CUDA版本是否兼容
- 尝试使用不同的内存模式（--lowvram、--normalvram等）

### 5.2 GPU利用率低
- 检查是否使用了正确的启动参数
- 降低视频分辨率和采样步骤
- 确保ComfyUI确实在使用GPU（检查启动日志）

### 5.3 视频生成超时
- 增加timeout参数：修改`generate_video.py`中的timeout值
- 降低视频时长和分辨率
- 检查网络连接和服务状态

## 6. 停止项目服务
```bash
# 停止所有Python进程
taskkill /F /IM python.exe /T
```

## 7. 优化建议
- **使用快捷方式**：为ComfyUI创建桌面快捷方式，方便快速启动
- **保存配置**：将常用的启动命令保存到批处理文件（.bat）中
- **定期更新**：定期更新ComfyUI和依赖包，获取更好的性能和稳定性
- **监控资源**：使用任务管理器或专业工具监控CPU、内存和GPU使用情况

## 8. 项目结构说明
```
ai-agent-comfy/
├── backend/                 # 后端服务
│   ├── app/                # 核心应用代码
│   ├── config.py           # 配置文件
│   ├── requirements.txt    # 依赖列表
│   └── run.py              # 后端启动脚本
├── crawler/                # 抖音爬虫
│   └── Douyin_TikTok_Download_API-main/
├── generate_video.py        # 视频生成脚本
├── check_comfyui.py        # ComfyUI状态检查脚本
└── output/                 # 生成的视频输出目录
```

## 9. 技术支持
如有任何问题，请参考：
- 项目文档：本目录下的说明文档
- 常见问题：`常见问题.md`
- GitHub Issues：提交问题到项目仓库

---

**注意**：首次运行时，系统会自动下载必要的模型文件，这可能需要一些时间和网络带宽。请确保网络连接稳定，耐心等待下载完成。
