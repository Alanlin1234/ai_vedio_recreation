# AI视频生成系统 - 完整使用说明

## 🎯 项目概述

这是一个基于AI的自动化视频生成系统，能够从热点采集、脚本生成、图像生成到视频合成的全流程自动化处理。系统包含8个AI Agent协同工作，支持多种风格和主题的视频创作。

### 核心功能
- 🔥 **热点采集** - 自动采集抖音热点内容
- 📝 **脚本生成** - AI自动生成视频脚本
- 🎨 **图像生成** - 使用Flux模型生成高质量图像
- 🎬 **视频合成** - 自动合成图像序列为视频
- 🔍 **一致性检验** - 确保场景风格统一
- 📊 **追踪系统** - 完整的执行记录和监控

## 🚀 快速开始

### 系统要求
- Python 3.8+
- ComfyUI（图像生成引擎）
- 至少8GB内存
- 支持CUDA的GPU（推荐）

### 1. 环境准备

#### 安装依赖
```bash
# 进入后端目录
cd d:\ai-agent-comfy\backend

# 安装Python依赖
pip install -r requirements.txt
```

#### 配置环境变量
```bash
# 复制环境变量模板
copy .env.example .env

# 编辑.env文件，配置以下关键参数
```

**必需配置**：
```bash
# ComfyUI服务地址（必须配置）
COMFYUI_URL=http://127.0.0.1:8188

# 大模型API（用于脚本生成）
DASHSCOPE_API_KEY=your_dashscope_api_key
SILICONFLOW_API_KEY=your_siliconflow_api_key
```

**可选配置**：
```bash
# 抖音API（热点采集）
DOUYIN_API_KEY=your_douyin_api_key
DOUYIN_API_SECRET=your_douyin_secret

# 图像搜索API（参考图）
IMAGE_SEARCH_API_KEY=your_image_search_key

# 视觉API（一致性检验）
VISION_API_KEY=your_vision_api_key
```

### 2. 启动ComfyUI

ComfyUI是图像生成的核心引擎，需要单独启动：

```bash
# 假设ComfyUI安装在D:\ComfyUI
cd D:\ComfyUI
python main.py
```

**验证ComfyUI运行**：
- 访问 http://127.0.0.1:8188
- 应该能看到ComfyUI的Web界面

### 3. 启动系统服务

#### 启动后端服务（端口5000）
```bash
cd d:\ai-agent-comfy\backend
python run.py
```

#### 启动抖音爬虫服务（端口5001）
```bash
cd d:\ai-agent-comfy\douyin_crawler\Douyin_TikTok_Download_API-main
python start.py
```

### 4. 验证系统状态

#### 检查服务状态
```bash
# 检查后端服务
curl http://localhost:5000/health

# 检查爬虫服务
curl http://localhost:5001/health
```

#### 运行测试
```bash
# 测试视频生成流程
python test_full_video_workflow.py

# 测试追踪系统
python test_tracking_system.py
```

## 📋 API使用指南

### 核心API端点

#### 1. 创建视频（主要接口）
```bash
POST http://localhost:5000/api/agent/create-video
```

**请求示例**：
```json
{
    "keywords": ["人工智能", "科技"],
    "style": "cinematic",
    "duration": 60,
    "batch_size": 2,
    "output_filename": "my_ai_video.mp4"
}
```

**参数说明**：
- `keywords`: 视频主题关键词数组
- `style`: 视频风格（cinematic, documentary, educational等）
- `duration`: 视频时长（秒）
- `batch_size`: 批量生成数量
- `output_filename`: 输出文件名

#### 2. 获取热点列表
```bash
GET http://localhost:5000/api/hotspots
```

#### 3. 获取生成状态
```bash
GET http://localhost:5000/api/tracking/session/{session_id}
```

### Python代码调用示例

```python
import requests
import json

# 创建视频请求
def create_video(keywords, style="cinematic", duration=60):
    url = "http://localhost:5000/api/agent/create-video"
    payload = {
        "keywords": keywords,
        "style": style,
        "duration": duration
    }
    
    response = requests.post(url, json=payload)
    if response.status_code == 200:
        result = response.json()
        print(f"视频生成成功: {result['final_video']}")
        return result
    else:
        print(f"生成失败: {response.text}")
        return None

# 使用示例
result = create_video(["AI", "科技"], "cinematic", 60)
```

## 🎬 使用场景示例

### 场景1：科技主题视频
```bash
curl -X POST http://localhost:5000/api/agent/create-video \
  -H "Content-Type: application/json" \
  -d '{
    "keywords": ["人工智能", "机器学习", "深度学习"],
    "style": "educational",
    "duration": 120
  }'
```

### 场景2：娱乐热点视频
```bash
curl -X POST http://localhost:5000/api/agent/create-video \
  -H "Content-Type: application/json" \
  -d '{
    "keywords": ["娱乐", "热点", "短视频"],
    "style": "cinematic",
    "duration": 30
  }'
```

### 场景3：批量生成
```bash
curl -X POST http://localhost:5000/api/agent/create-video \
  -H "Content-Type: application/json" \
  -d '{
    "keywords": ["科技"],
    "style": "cinematic",
    "duration": 60,
    "batch_size": 3
  }'
```

## 🔧 高级配置

### ComfyUI工作流配置

编辑 `backend/comfyui_workflow_template.py`：

```python
# Flux工作流配置
FLUX_WORKFLOW = {
    "prompt": {
        "inputs": {
            "seed": 123456,
            "steps": 30,
            "cfg": 7.5,
            "width": 1024,
            "height": 576
        }
    }
}

# 标准SD工作流配置
SD_WORKFLOW = {
    "prompt": {
        "inputs": {
            "seed": 123456,
            "steps": 20,
            "cfg": 7.0,
            "width": 512,
            "height": 512
        }
    }
}
```

### 图像生成参数调整

在 `backend/config.py` 中调整：

```python
class Config:
    # 图像生成参数
    IMAGE_GENERATION = {
        "default_width": 1024,
        "default_height": 576,
        "max_steps": 30,
        "default_cfg": 7.5,
        "batch_size": 2
    }
    
    # 视频合成参数
    VIDEO_SYNTHESIS = {
        "fps": 24,
        "transition_duration": 1.0,
        "audio_enabled": True
    }
```

## 📊 监控和调试

### 查看实时日志
```bash
# 后端服务日志
tail -f d:\ai-agent-comfy\logs\backend.log

# Agent执行日志
tail -f d:\ai-agent-comfy\logs\agent_system.log
```

### 追踪系统使用

每个视频生成会话都有完整的追踪记录：

```bash
# 查看所有会话
curl http://localhost:5000/api/tracking/sessions

# 查看特定会话详情
curl http://localhost:5000/api/tracking/session/{session_id}
```

### 性能监控

系统提供以下监控指标：
- 图像生成成功率
- 平均生成时间
- 资源使用情况
- 错误统计

## 🐛 故障排除

### 常见问题及解决方案

#### 问题1：ComfyUI连接失败
**症状**：`ConnectionError: Failed to connect to ComfyUI`

**解决**：
1. 检查ComfyUI是否运行：`curl http://127.0.0.1:8188`
2. 确认COMFYUI_URL配置正确
3. 重启ComfyUI服务

#### 问题2：API密钥错误
**症状**：`APIError: Invalid API key`

**解决**：
1. 检查.env文件中的API密钥配置
2. 确认密钥有足够的额度
3. 验证API服务状态

#### 问题3：内存不足
**症状**：`MemoryError: CUDA out of memory`

**解决**：
1. 减少batch_size参数
2. 降低图像分辨率
3. 关闭其他GPU应用

#### 问题4：视频合成失败
**症状**：`VideoSynthesisError: Failed to create video`

**解决**：
1. 检查ffmpeg是否安装
2. 验证图像文件路径
3. 检查磁盘空间

### 调试模式

启用详细日志：
```bash
# 设置环境变量
set LOG_LEVEL=DEBUG

# 重启服务
python run.py
```

## 📁 文件结构说明

```
d:\ai-agent-comfy\
├── backend\                 # 后端核心系统
│   ├── app\                # 应用代码
│   │   ├── agents\         # 8个AI Agent
│   │   ├── services\       # 业务服务
│   │   ├── routes\         # API路由
│   │   └── models\         # 数据模型
│   ├── config.py           # 系统配置
│   ├── run.py              # 启动脚本
│   └── requirements.txt    # 依赖列表
├── douyin_crawler\         # 抖音爬虫系统
├── output\                 # 输出目录
│   ├── comfyui\           # 生成的图像
│   └── videos\            # 最终视频
├── references\            # 参考资源
└── logs\                  # 系统日志
```

## 🔄 工作流程详解

### 完整视频生成流程

1. **热点采集** → 2. **脚本生成** → 3. **分镜规划** → 4. **图像生成** → 5. **一致性检验** → 6. **视频合成**

#### 阶段1：热点采集（HotspotAgent）
- 采集抖音热点内容
- 分析热门话题趋势
- 选择适合的视频主题

#### 阶段2：脚本生成（ScriptAgent）
- 基于热点生成视频脚本
- 结构化内容拆解
- 生成场景描述

#### 阶段3：分镜规划（StoryboardAgent）
- 将脚本转换为分镜
- 设计镜头和场景
- 规划图像生成需求

#### 阶段4：图像生成（ImageGenerationAgent）
- 调用ComfyUI生成关键帧
- 使用Flux模型生成高质量图像
- 批量处理多个场景

#### 阶段5：一致性检验（ConsistencyAgent）
- 检查场景风格一致性
- 图像质量评估
- 自动重生成失败场景

#### 阶段6：视频合成（VideoSynthesisAgent）
- 合成图像序列为视频
- 添加音频和特效
- 输出最终视频文件

## 🎯 最佳实践

### 性能优化建议

1. **图像生成优化**
   - 使用合适的图像分辨率（推荐1024x576）
   - 合理设置batch_size（2-4为宜）
   - 启用GPU加速

2. **API调用优化**
   - 使用异步处理提高并发
   - 合理设置超时时间
   - 实现错误重试机制

3. **存储优化**
   - 定期清理临时文件
   - 使用SSD存储提高IO性能
   - 设置合理的缓存策略

### 质量控制

1. **风格一致性**
   - 使用相同的提示词模板
   - 保持统一的色彩风格
   - 确保场景过渡自然

2. **内容质量**
   - 验证生成脚本的逻辑性
   - 检查图像的清晰度
   - 确保音频视频同步

3. **用户体验**
   - 提供进度反馈
   - 实现错误友好提示
   - 支持结果预览

## 📞 技术支持

### 获取帮助
- 查看详细日志文件
- 使用追踪系统分析问题
- 参考系统文档

### 联系方式
- 项目文档：查看backend目录下的.md文件
- 问题反馈：检查logs目录下的错误日志
- 社区支持：参考相关技术论坛

## 🚀 下一步

### 扩展功能
1. **多语言支持** - 支持英文、日文等语言
2. **自定义模板** - 用户自定义视频模板
3. **实时预览** - 生成过程中的实时预览
4. **批量处理** - 大规模视频批量生成

### 性能提升
1. **分布式处理** - 支持多机并行生成
2. **模型优化** - 优化图像生成模型
3. **缓存机制** - 实现智能缓存
4. **CDN集成** - 集成内容分发网络

---

**开始你的AI视频创作之旅吧！** 🎬

如果有任何问题，请参考本文档的故障排除部分，或查看系统日志获取详细信息。